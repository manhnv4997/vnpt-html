$(document).ready(function () {
    function removeOption() {
      $(".js_close")
        .removeClass("js_close")
        .click(function () {
          $(this).parents(".control-group").remove();
          b--;
          if (b === 3) {
            $(".icon-remove").addClass("hide");
          }
          var a = 1;
          $(".icon-remove").each(function () {
            $(this)
              .parents(".control-group")
              .find("input")
              .attr("placeholder", "Lựa chọn " + a);
            a++;
          });
          return false;
        });
    }
  
    var c = top.tinymce.activeEditor,
      d = c.selection.getNode();
  
    if ("P" == d.nodeName && $(d).hasClass("exp_area_vote")) {
      var f = $(d).find(".vote_id").text();
      $.ajax({
        type: "GET",
        url: "/?mod=vote&act=getVote&id=" + f,
        dataType: "html",
        success: function (a) {
          a = jQuery.parseJSON(a);
          $("#frm_vote input[name=vote_id]").val(f);
          $("#frm_vote textarea[name=title]").val(a.title);
          a = jQuery.parseJSON(a.answers);
          $.each(a, function (a, g) {
            if (a > 1) {
              $(".add_choose").click();
            }
            $("#frm_vote .icon-remove:eq(" + a + ")")
              .parents(".control-group")
              .find("input")
              .val(g);
          });
          $("#btn_insert_content").html('<i class="icon-ok"></i> Cập nhật');
          $("#btn_add").click();
        },
        error: function (a, b) {
          alert("Can't do because: " + b);
        },
      });
    }
  
    var b = 3;
  
    $(".add_choose").click(function () {
      $(this)
        .parents(".control-group")
        .before(
          '<div class="control-group"><div class="controls"><input type="text" name="answers[]" value="" class="span12 m-wrap required" placeholder="Lựa chọn ' +
            b +
            '" /><i class="icon-remove js_close"></i></div></div>'
        );
      removeOption();
      b++;
      if (b === 4) {
        $(".icon-remove").removeClass("hide");
      }
      $(".icon-remove:last")
        .parents(".control-group")
        .find("input")
        .focus();
      return false;
    });
  
    removeOption();
  
    $("#frm_vote .required").each(function () {
      var a = $(this).parents(".control-group");
      $(this).keyup(function () {
        if (a.hasClass("error")) {
          a.removeClass("error");
        }
      });
      $(this).change(function () {
        if (a.hasClass("error")) {
          a.removeClass("error");
        }
      });
    });
  
    $("#frm_vote").submit(function () {
      var a = false;
      $(this)
        .find(".required")
        .each(function () {
          var b = $(this).val();
          if (!b || b === "" || b === "0") {
            $(this).parents(".control-group").addClass("error");
            a = true;
          }
        });
  
      if (a) {
        $(this).find(".error:eq(0) .required").focus();
        alert("Vui lòng nhập đầy đủ thông tin");
        return false;
      }
  
      var b = $(this).attr("action");
      $.ajax({
        type: "POST",
        url: b,
        data: $("#frm_vote").serialize(),
        dataType: "html",
        success: function (a) {
          c.execCommand("mceInsertContent", false, a);
          c.windowManager.close();
        },
        error: function (a, b) {
          alert("Can't do because: " + b);
        },
      });
      return false;
    });
  
    $(".btn_one_vote").click(function () {
      var a = $(this).attr("data-id"),
        b = $(this).text();
      c.execCommand(
        "mceInsertContent",
        false,
        '<p class="expNoEdit exp_area_vote widget_vote"><span class="vote_id" style="display:none">' +
          a +
          '</span><span class="vote_gm">' +
          b +
          '</span></p>'
      );
      c.windowManager.close();
      return false;
    });
    
    $("#btn_add").click(function () {
      $("#frm_vote").show();
      $("#frm_list").hide();
      return false;
    });
  
    $("#btn_search").click(function () {
      $("#frm_vote").hide();
      $("#frm_list").show();
      return false;
    });
  });
  